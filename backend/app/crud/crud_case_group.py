
from typing import Sequence
from sqlalchemy import and_, asc, or_, select, insert, update, delete
from sqlalchemy.ext.asyncio import AsyncSession

from backend.app.crud.base import CRUDBase
from backend.app.models import CaseGroup
from backend.app.schemas.fuzz_test import UpdateGroupSchema, CreateGroupSchema


class CRUDCaseGroup(CRUDBase[CaseGroup, CreateGroupSchema, UpdateGroupSchema]):
    """
    增删改查模糊测试用例组。

    :param CRUDBase: CRUD基类。
    """
    async def get_group_by_id(self, db: AsyncSession, group_id: int) -> CaseGroup | None:
        return await self.get_(db, primary_key=group_id)

    async def get_group(
        self, db: AsyncSession, user_id: int, group_name: str
    ) -> CaseGroup | None:

        group = await db.execute(
            select(CaseGroup).where(CaseGroup.name ==
                                    group_name and CaseGroup.user_id == user_id)
        )
        return group.scalars().first()

    # async def create_group(self, db: AsyncSession, user_id:int, name, desc=None) -> None:
    #     """
    #     创建一个名为name,描述为desc的模糊测试用例组

    #     :param db: _description_
    #     :param user_id: _description_
    #     :param create_group: 含有name和desc属性的CreateGroup对象
    #     """
    #     case_group = CaseGroup(user_id=user_id, name=name, desc=desc)
    #     db.add(case_group)

    async def create_group(self, db: AsyncSession, user_id, name, desc=None) -> None:
        print('create_group',name)
        case_group = CaseGroup(user_id=user_id, name=name, desc=desc)
        db.add(case_group)

    async def update_group(
        self, db: AsyncSession, user_id: int, old_name: str, new_name: str, new_desc: str = None
    ) -> None:
        """
        将名为old_name,描述为old_desc的模糊测试用例组的名称和描述改为new_name和new_desc.

        :param db: _description_
        :param new_name: _description_
        :param new_desc: _description_, defaults to None
        """
        group = await db.execute(
            update(CaseGroup).where(
                CaseGroup.name == old_name and CaseGroup.user_id == user_id
            ).values(name=new_name, desc=new_desc)
        )
        return group.rowcount

    async def delete_group(self, db: AsyncSession, user_id: int, name: str) -> int:
        group = await db.execute(delete(CaseGroup).where( CaseGroup.user_id == user_id and CaseGroup.name == name))
        db.commit()
        return group.rowcount
