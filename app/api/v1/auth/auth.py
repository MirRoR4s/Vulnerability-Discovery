"""认证接口,包括用户登陆 登出 获取登陆验证码 创建 token 表单登陆等功能"""
from typing import Annotated
from fastapi import APIRouter, Depends, Query, Request
from fastapi.security import OAuth2PasswordRequestForm
from fastapi_limiter.depends import RateLimiter
from starlette.background import BackgroundTasks
from ....common.jwt import DependsJwtAuth
from ....common.response.response_schema import response_base
from ....schemas.token import GetLoginToken, GetNewToken, GetSwaggerToken
from ....schemas.user import AuthLogin
from ....services.auth_service import AuthService


router = APIRouter()


@router.post('/swagger_login', summary='swagger 表单登录', description='form 格式登录，仅用于 swagger 文档调试接口')
async def swagger_user_login(form_data: OAuth2PasswordRequestForm = Depends()) -> GetSwaggerToken:
    """
    User login with Swagger authentication.

    :param form_data: The form data containing the user credentials.
    :return: The Swagger token and user information.
    """
    token, user = await AuthService().swagger_login(form_data=form_data)
    return GetSwaggerToken(access_token=token, user=user)  # type: ignore


@router.post(
    '/login',
    summary='用户登录',
    description='json 格式登录, 仅支持在第三方api工具调试接口, 例如: postman',
    dependencies=[Depends(RateLimiter(times=5, minutes=1))], # 用户每分钟最多可以发送5次请求
)
async def user_login(request: Request, obj: AuthLogin, background_tasks: BackgroundTasks):
    """
    Perform user login and return login tokens.

    :param request: The request object.
    :param obj: The AuthLogin object containing login credentials.
    :param background_tasks: The background tasks to be executed.
    :return: The login tokens and user information.
    """
    access_token, refresh_token, access_expire, refresh_expire, user = await AuthService().login(
        request=request, obj=obj, background_tasks=background_tasks
    )
    data = GetLoginToken(
        access_token=access_token,
        refresh_token=refresh_token,
        access_token_expire_time=access_expire,
        refresh_token_expire_time=refresh_expire,
        user=user,  # type: ignore
    )
    return await response_base.success(data=data)


@router.post('/new_token', summary='创建新 token', dependencies=[DependsJwtAuth])
async def create_new_token(request: Request, refresh_token: Annotated[str, Query(...)]):
    (
        new_access_token,
        new_refresh_token,
        new_access_token_expire_time,
        new_refresh_token_expire_time,
    ) = await AuthService.new_token(request=request, refresh_token=refresh_token)
    data = GetNewToken(
        access_token=new_access_token,
        access_token_expire_time=new_access_token_expire_time,
        refresh_token=new_refresh_token,
        refresh_token_expire_time=new_refresh_token_expire_time,
    )
    return await response_base.success(data=data)


@router.post('/logout', summary='用户登出', dependencies=[DependsJwtAuth])
async def user_logout(request: Request):
    await AuthService.logout(request=request)
    return await response_base.success()
